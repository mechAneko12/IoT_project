<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>学習記録</title>
</head>
<body>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script src="https://ajax.aspnetcdn.com/ajax/jQuery/jquery-3.4.1.min.js"></script>
    <button type = "button" id = "upcount">▶</button>
    <button type = "button" id = "downcount">◀</button>
  <div class="contents margin">
    <button id="scan" class="button">sample</button>
  </div>
  
  <script type="text/javascript">
    function getCookie(name) {
      var cookieValue = null;
      if (document.cookie && document.cookie !== '') {
          var cookies = document.cookie.split(';');
          for (var i = 0; i < cookies.length; i++) {
              var cookie = jQuery.trim(cookies[i]);
              // Does this cookie string begin with the name we want?
              if (cookie.substring(0, name.length + 1) === (name + '=')) {
                  cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                  break;
              }
          }
      }
      return cookieValue;
    }
    var csrftoken = getCookie('csrftoken');

    function csrfSafeMethod(method) {
        // these HTTP methods do not require CSRF protection
        return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
    }
    $.ajaxSetup({
        beforeSend: function(xhr, settings) {
            if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                xhr.setRequestHeader("X-CSRFToken", csrftoken);
            }
        }
    });


    var date = new Date();
    const dayOfWeek = date.getDay() ;	// 曜日(数値)

    var week = [];
    date.setDate(date.getDate() - dayOfWeek);
    for (  var j = 0;  j < 7;  j++  ){
      
      var year = date.getFullYear() ;	// 年
      var month = date.getMonth() + 1 ;	// 月
      var day = date.getDate() ;	// 日
      var date_str = String(year)+"/"+String(month)+"/"+String(day);
      console.log(date_str);
      week.push(date_str);
      date.setDate(date.getDate()  + 1);
    }
    var time;
    var num;
    var column;
    var d;


    response = get_sql(week);
    response.then(function(data){
      console.log(data.d);
      console.log(typeof data.d);
      var result = data.d.replace(/'/g, '"');
      console.log(JSON.parse(result));
      console.log(JSON.parse(result).time[0][0][0]);
      time = JSON.parse(result).time;
      num = JSON.parse(result).num;
      column = JSON.parse(result).column;
      var n = column.length;
      var column_name;
      var column_index;

      var col = [""];

      d =[[""],[""],[""],[""],[""],[""],[""]];//最終敵にdataに入れる配列の原型

      for (var j = 0; j < 7; j++){
        for (var k = 0; k < n; k++){
          d[j].push(0);//0を格納
          if(j ===6){
            col.push(column[k])
          }
          
          console.log(n,col[k],d[j][k]);

        }
        console.log(d[j].length)

        if (num[j] === 0){//nodataを無視

        }else{
          for (var l = 0; l < num[j]; l++){
            column_name = time[j][l][0];//j曜日のl番目のcolumn名を抽出
            column_index = column.indexOf(column_name);
            d[j][column_index+1] += time[j][l][1];
            if (l === (num[j]-1)){
              d[j][column_index+1] = Math.round(d[j][column_index+1]/3600);
            }
          }
        }
      }
      d.unshift(col)
      for (var m = 1; m < 8; m++){
        //d[m].unshift(week[m]);
        d[m][0] = week[m];
        
      }
      for (var o = 0; o< 8; o++){
        for (var p = 0; p< d[o].length; p++){
          console.log(d[o][p]);
        }
        console.log(d[o].length);
      }

      google.load("visualization", "1", {packages:["corechart"]});
      google.setOnLoadCallback(draw);
    });

    

    
    /*
    for (var j = 0; j < 7; j++){
      for (var k = 0; k < n; k++){
        d[j].push(0);//0を格納
      }

      if (num[j] === 0){//nodataを無視

      }else{
        for (var l = 0; l < num[j]; l++){
          var column_name = time[j][l][0];//j曜日のl番目のcolumn名を抽出
          var column_index = column.indexOf(column_name);
          d[j][column_index] += time[j][l][1];
        }
      }
    }
    d.unshift(column.unshift(""))
    for (var m = 0; m < 7; m++){
      d[m].unshift(week[m]);
    }*/
    


    var i = 0;
    var data;
    var chart;
  
    //google.load("visualization", "1", {packages:["corechart"]});
    //google.setOnLoadCallback(draw);
    function draw(){
        data = google.visualization.arrayToDataTable(d);
  
        var options = {
            title: '項目別作業時間',
            hAxis: {title: '日付'},
            isStacked: true,
            vAxis:{minValue:0,maxValue:23,gridlined:{count:12 }}
        };
        if (column.length === 0){
          data = google.visualization.arrayToDataTable([
              [     '', 'nodata'],
              [week[0],        0],
              [week[1],        0],
              [week[2],        0],
              [week[3],        0],
              [week[4],        0],
              [week[5],        0],
              [week[6],        0],
          ]);
        }
  
        chart = new google.visualization.ColumnChart(document.getElementById('gct_sample_column'));
        chart.draw(data, options);
  
        
    }

    document.getElementById("upcount").onclick = function (){
      d = [[""],[""],[""],[""],[""],[""],[""]];
      week = []
      date.setDate(date.getDate());
      for (  var j = 0;  j < 7;  j++  ){
        
        var year = date.getFullYear() ;	// 年
        var month = date.getMonth() + 1 ;	// 月
        var day = date.getDate() ;	// 日
        var date_str = String(year)+"/"+String(month)+"/"+String(day);
        console.log(date_str);
        week.push(date_str);
        date.setDate(date.getDate()  + 1);
      }
      response = get_sql(week);
      response.then(function(data){
        console.log(data.d);
        console.log(typeof data.d);
        var result = data.d.replace(/'/g, '"');
        console.log(JSON.parse(result));
        console.log(JSON.parse(result).time[0][0][0]);
        time = JSON.parse(result).time;
        num = JSON.parse(result).num;
        column = JSON.parse(result).column;
        var n = column.length
        col = [""];

        d =[[""],[""],[""],[""],[""],[""],[""]];//最終敵にdataに入れる配列の原型

        for (var j = 0; j < 7; j++){
          for (var k = 0; k < n; k++){
            d[j].push(0);//0を格納
            if(j ===6){
              col.push(column[k])
            }
            
            console.log(n,col[k],d[j][k]);

          }
          console.log(d[j].length)

          if (num[j] === 0){//nodataを無視

          }else{
            for (var l = 0; l < num[j]; l++){
              column_name = time[j][l][0];//j曜日のl番目のcolumn名を抽出
              column_index = column.indexOf(column_name);
              d[j][column_index+1] += time[j][l][1];
              if (l === (num[j]-1)){
                d[j][column_index+1] = Math.round(d[j][column_index+1]/3600);
              }
            }
          }
        }
        d.unshift(col)
        for (var m = 1; m < 8; m++){
          //d[m].unshift(week[m]);
          d[m][0] = week[m];
          
        }
        for (var o = 0; o< 8; o++){
          for (var p = 0; p< d[o].length; p++){
            console.log(d[o][p]);
          }
          console.log(d[o].length);
        }

        data = google.visualization.arrayToDataTable(d);
        if (column.length === 0){
          data = google.visualization.arrayToDataTable([
              [     '', 'nodata'],
              [week[0],        0],
              [week[1],        0],
              [week[2],        0],
              [week[3],        0],
              [week[4],        0],
              [week[5],        0],
              [week[6],        0],
          ]);
        }
        var options = {
            title: '項目別作業時間',
            hAxis: {title: '日付'},
            isStacked: true,
            vAxis:{minValue:2,maxValue:22,gridlined:{count:12 }}
        };
        chart.draw(data,options);
      });
      
      data = google.visualization.arrayToDataTable([
          [       '', '売上高', '営業利益', '経常利益'],
          ['2004 年',     1000+parseInt(i),        400,        380],
          ['2005 年',     1170,        460,        400],
          ['2006 年',      660,       1120,        900],
          ['2007 年',     1030,        540,        480],
          ['2008 年',     1350,        750,        800]
      ]);
  
      
    }

    

    function get_sql(week){
        return $.ajax({
            url: '/table/sql_get/',
            type: 'POST',
            headers:{'X-CSRFToken': '{{csrf_token}}'},
            
            dataType: 'json',
            //contentType: 'application/json',
            data: {
              'sun': week[0],
              'mon': week[1],
              'tue': week[2],
              'wed': week[3],
              'thu': week[4],
              'fri': week[5],
              'sat': week[6],
            }
        }).done(function(data, textStatus, jqXHR) {
            return data;
        });
      }
    
  </script>
  <div id="gct_sample_column" style="width:80%; height:250pt" ></div>
  
  <ul>
    <li>イベントA</li>
    <li>イベントB</li>
    <li>イベントC</li>
    <li>イベントD</li>
    <li>イベントE</li>
  </ul>
</body>
</html>