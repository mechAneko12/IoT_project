<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Web Bluetooth API Testing</title>
  </head>
  <body>
    <p>BLE</p>
    <p><form><button id="startNotifications">Start notifications</button></form></p>
    <div id="accelerometer" style="width:100%; height:200px;"></div>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script>
      var XAxisCharacteristic;
      var ax;
      let serviceUuid = "0000dfb0-0000-1000-8000-00805f9b34fb";
      let XAxisUuid = "0000dfb2-0000-1000-8000-00805f9b34fb";
      google.charts.load('current', {'packages':['line']});
      google.charts.setOnLoadCallback(drawAccelChart);
      var accOptions = {
        title: '',
        // curveType: 'function',
        legend: { position: 'bottom' },
        vAxis: { minValue: -1000, maxValue: 1000 },
      };
      var gaccel, chart;
      function beginBLE(){
        // 接続するデバイスをある程度絞ってからAdvertisingが動作する
        //let filters = [];
        //filters.push({services: [serviceUuid]});
        navigator.bluetooth.requestDevice({acceptAllDevices:true, optionalServices: [serviceUuid]})
          .then(device => {
            console.log("Connecting to device");
            return device.gatt.connect();
          })
          .then(server => {
            console.log('Getting Service...');
            return server.getPrimaryService(serviceUuid);
          })
          .then(service => {
            // Serviceが複数ある場合はservicesで配列となる
            console.log('Getting Characteristic...');
            if (XAxisUuid) {
            // Get all characteristics that match this UUID.
            return service.getCharacteristic(XAxisUuid);
            }
          })
          .then(characteristic => {
            return characteristic.readValue();
          })
          .then(value => {
            let batteryLevel = value.getUint8(0);
            console.log(`> バッテリーレベルは${batteryLevel}%です`);
          })
          .then(characteristic => {
            //console.log("Error1: ");
            // characteristicsが単数の場合はcharacteristicとなる
            //console.log("Error1.5: ");
            if(characteristic.uuid === XAxisUuid){
              //console.log("Error2: ");
              XAxisCharacteristic = characteristic;
              console.log(characteristic);
              XAxisCharacteristic.startNotifications().then(_ => {
                 console.log("XAxis notification started");
                 console.log("a" + XAxisCharacteristic.readValue().getUint8(0));
                 console.log("a");
                 XAxisCharacteristic.addEventListener('characteristicvaluechanged', handleNotifications);
               });
            }
              
            
          })
          .catch(error =>{
            console.log("Error: " + error);
          });
      }
      function handleNotifications(event) {
        console.log("Error1: ");
        if(event.target.uuid === XAxisUuid){
          console.log("Error2: ");
          ax = event.target.value.getFloat32(0,true);
        } 
        console.log("Erro3r: ");
        gaccel.addRow([new Date(), ax]);
        console.log("Erro3r: ");
        console.log(ax);
        if(gaccel.getNumberOfRows() > 100){
          gaccel.removeRow(0);
        }
        chart.draw(gaccel, accOptions);
      }
      document.querySelector('#startNotifications').addEventListener('click', function(event) {
        event.stopPropagation();
        event.preventDefault();
        console.log("Begin BLE scanning");
        beginBLE();
      });
      function drawAccelChart() {
        gaccel = new google.visualization.DataTable();
        gaccel.addColumn('datetime', 'Time');
        gaccel.addColumn('number', 'X');
        gaccel.addRow([new Date(), 1]);
        chart = new google.charts.Line(document.getElementById('accelerometer'));
        chart.draw(gaccel, accOptions);
      }
    </script>
  </body>
</html>